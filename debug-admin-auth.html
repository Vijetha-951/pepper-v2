<!DOCTYPE html>
<html>
<head>
    <title>Admin Authentication Debug</title>
</head>
<body>
    <h1>Admin Authentication Debug</h1>
    <div id="output"></div>
    <button onclick="testAuth()">Test Authentication</button>
    <button onclick="testAdminAPI()">Test Admin API</button>
    <button onclick="clearAuth()">Clear Auth & Logout</button>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <script>
    const log = (msg) => {
        const output = document.getElementById('output');
        output.innerHTML += '<p>' + new Date().toLocaleTimeString() + ': ' + msg + '</p>';
        console.log(msg);
    };

    // Initialize Firebase - you'll need to add your config
    const firebaseConfig = {
        // Add your Firebase config here from frontend/.env
        apiKey: "demo", // This is just for testing
        authDomain: "demo.firebaseapp.com",
        projectId: "demo"
    };
    
    try {
        firebase.initializeApp(firebaseConfig);
        log('Firebase initialized');
    } catch (e) {
        log('Firebase init error: ' + e.message);
    }

    async function testAuth() {
        log('=== Testing Authentication ===');
        
        // Check localStorage
        const storedUser = localStorage.getItem('user');
        const storedToken = localStorage.getItem('token');
        log('localStorage user: ' + (storedUser ? 'EXISTS' : 'NONE'));
        log('localStorage token: ' + (storedToken ? 'EXISTS' : 'NONE'));
        
        if (storedUser) {
            try {
                const user = JSON.parse(storedUser);
                log('User email: ' + user.email);
                log('User role: ' + user.role);
                log('Is admin: ' + (user.role === 'admin'));
                log('Is correct admin email: ' + (user.email === 'vj.vijetha01@gmail.com'));
            } catch (e) {
                log('Error parsing stored user: ' + e.message);
            }
        }
        
        // Check Firebase auth
        if (firebase.auth) {
            const currentUser = firebase.auth().currentUser;
            if (currentUser) {
                log('Firebase user: ' + currentUser.email);
                log('Firebase UID: ' + currentUser.uid);
                
                try {
                    const token = await currentUser.getIdToken(true);
                    log('Firebase token obtained: ' + token.substring(0, 50) + '...');
                } catch (e) {
                    log('Firebase token error: ' + e.message);
                }
            } else {
                log('No Firebase user signed in');
            }
        } else {
            log('Firebase auth not available');
        }
    }

    async function testAdminAPI() {
        log('=== Testing Admin API ===');
        
        // Get token
        let token = localStorage.getItem('token');
        if (!token && firebase.auth && firebase.auth().currentUser) {
            try {
                token = await firebase.auth().currentUser.getIdToken(true);
                log('Using Firebase token');
            } catch (e) {
                log('Error getting Firebase token: ' + e.message);
                return;
            }
        }
        
        if (!token) {
            log('No authentication token available');
            return;
        }
        
        // Test admin endpoints
        const endpoints = [
            '/api/admin/products',
            '/api/admin/users',
            '/api/admin/stock'
        ];
        
        for (const endpoint of endpoints) {
            try {
                log('Testing: ' + endpoint);
                const response = await fetch(endpoint, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    }
                });
                
                log('Status: ' + response.status + ' ' + response.statusText);
                
                if (response.ok) {
                    const data = await response.json();
                    log('Success: ' + JSON.stringify(data).substring(0, 100) + '...');
                } else {
                    const errorText = await response.text();
                    log('Error: ' + errorText);
                }
            } catch (e) {
                log('Network error for ' + endpoint + ': ' + e.message);
            }
        }
    }

    function clearAuth() {
        log('=== Clearing Authentication ===');
        localStorage.removeItem('user');
        localStorage.removeItem('token');
        localStorage.removeItem('currentUser');
        
        if (firebase.auth && firebase.auth().currentUser) {
            firebase.auth().signOut().then(() => {
                log('Firebase signed out');
            }).catch((e) => {
                log('Firebase signout error: ' + e.message);
            });
        }
        
        log('Authentication cleared. Please refresh and login again.');
    }
    </script>
</body>
</html>