<!DOCTYPE html>
<html>
<head>
    <title>Debug Authentication State</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .warning { background: #fff3cd; border-color: #ffeaa7; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow: auto; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
    </style>
</head>
<body>
    <h1>üîç Authentication Debug Console</h1>
    
    <div class="section">
        <h3>Current Authentication State</h3>
        <button class="btn-primary" onclick="checkAuthState()">Check Auth State</button>
        <div id="auth-result"></div>
    </div>

    <div class="section">
        <h3>localStorage Data</h3>
        <button class="btn-primary" onclick="checkLocalStorage()">Check localStorage</button>
        <div id="storage-result"></div>
    </div>

    <div class="section">
        <h3>Backend Test</h3>
        <button class="btn-primary" onclick="testBackend()">Test Backend Connection</button>
        <div id="backend-result"></div>
    </div>

    <div class="section">
        <h3>Fix Actions</h3>
        <button class="btn-success" onclick="refreshLogin()">Refresh Login Session</button>
        <button class="btn-danger" onclick="clearAndRelogin()">Clear Data & Force Re-login</button>
        <div id="fix-result"></div>
    </div>

    <script type="module">
        // Import Firebase auth
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        // Firebase config (from your .env file)
        const firebaseConfig = {
            apiKey: "AIzaSyCa7ZC5CMHp6wEfkW-TVqO7t3mZuZAO1mQ",
            authDomain: "mca-internship-leopard.firebaseapp.com",
            projectId: "mca-internship-leopard",
            storageBucket: "mca-internship-leopard.appspot.com",
            messagingSenderId: "313407891935",
            appId: "1:313407891935:web:e8dcf127d15db6fa207c6a"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        window.checkAuthState = async function() {
            const result = document.getElementById('auth-result');
            result.innerHTML = '<p>Checking...</p>';

            try {
                const currentUser = auth.currentUser;
                
                let html = '';
                
                if (currentUser) {
                    const token = await currentUser.getIdToken();
                    html += `<div class="success">
                        <h4>‚úÖ Firebase User Authenticated</h4>
                        <pre>Email: ${currentUser.email}
UID: ${currentUser.uid}
Display Name: ${currentUser.displayName || 'None'}
Email Verified: ${currentUser.emailVerified}
Token Length: ${token.length}</pre>
                    </div>`;
                } else {
                    html += `<div class="error">
                        <h4>‚ùå No Firebase User</h4>
                        <p>No user is currently authenticated with Firebase</p>
                    </div>`;
                }

                result.innerHTML = html;
            } catch (error) {
                result.innerHTML = `<div class="error">
                    <h4>‚ùå Error checking auth state</h4>
                    <pre>${error.message}</pre>
                </div>`;
            }
        };

        window.checkLocalStorage = function() {
            const result = document.getElementById('storage-result');
            
            try {
                const userData = localStorage.getItem('user');
                
                if (userData) {
                    const parsed = JSON.parse(userData);
                    result.innerHTML = `<div class="success">
                        <h4>‚úÖ User Data Found in localStorage</h4>
                        <pre>${JSON.stringify(parsed, null, 2)}</pre>
                    </div>`;
                } else {
                    result.innerHTML = `<div class="warning">
                        <h4>‚ö†Ô∏è No User Data in localStorage</h4>
                        <p>This could be why you're being redirected to login</p>
                    </div>`;
                }
            } catch (error) {
                result.innerHTML = `<div class="error">
                    <h4>‚ùå Error reading localStorage</h4>
                    <pre>${error.message}</pre>
                </div>`;
            }
        };

        window.testBackend = async function() {
            const result = document.getElementById('backend-result');
            result.innerHTML = '<p>Testing backend...</p>';

            try {
                // Test health endpoint
                const healthResponse = await fetch('http://localhost:5000/api/health');
                const healthData = await healthResponse.json();

                let html = `<div class="success">
                    <h4>‚úÖ Backend Health Check</h4>
                    <pre>Status: ${healthResponse.status}
Data: ${JSON.stringify(healthData)}</pre>
                </div>`;

                // Test auth endpoint if user is logged in
                const currentUser = auth.currentUser;
                if (currentUser) {
                    try {
                        const token = await currentUser.getIdToken();
                        const authResponse = await fetch('http://localhost:5000/api/admin/products?page=1&limit=1', {
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        if (authResponse.ok) {
                            html += `<div class="success">
                                <h4>‚úÖ Admin API Access</h4>
                                <p>Successfully accessed admin endpoint</p>
                            </div>`;
                        } else {
                            const errorText = await authResponse.text();
                            html += `<div class="error">
                                <h4>‚ùå Admin API Failed</h4>
                                <pre>Status: ${authResponse.status}
Error: ${errorText}</pre>
                            </div>`;
                        }
                    } catch (e) {
                        html += `<div class="error">
                            <h4>‚ùå Admin API Test Failed</h4>
                            <pre>${e.message}</pre>
                        </div>`;
                    }
                }

                result.innerHTML = html;
            } catch (error) {
                result.innerHTML = `<div class="error">
                    <h4>‚ùå Backend Test Failed</h4>
                    <pre>${error.message}</pre>
                </div>`;
            }
        };

        window.refreshLogin = async function() {
            const result = document.getElementById('fix-result');
            result.innerHTML = '<p>Refreshing login session...</p>';

            try {
                const currentUser = auth.currentUser;
                if (currentUser) {
                    // Force token refresh
                    await currentUser.getIdToken(true);
                    
                    // Re-fetch user data from Firestore
                    // This would need to be implemented properly
                    result.innerHTML = `<div class="success">
                        <h4>‚úÖ Session Refreshed</h4>
                        <p>Try accessing the admin pages now</p>
                    </div>`;
                } else {
                    result.innerHTML = `<div class="warning">
                        <h4>‚ö†Ô∏è No User to Refresh</h4>
                        <p>Please log in first</p>
                    </div>`;
                }
            } catch (error) {
                result.innerHTML = `<div class="error">
                    <h4>‚ùå Refresh Failed</h4>
                    <pre>${error.message}</pre>
                </div>`;
            }
        };

        window.clearAndRelogin = function() {
            const result = document.getElementById('fix-result');
            
            // Clear localStorage
            localStorage.removeItem('user');
            
            // Sign out from Firebase
            auth.signOut().then(() => {
                result.innerHTML = `<div class="success">
                    <h4>‚úÖ Cleared Authentication Data</h4>
                    <p>Redirecting to login page...</p>
                </div>`;
                
                setTimeout(() => {
                    window.location.href = 'http://localhost:3000/login';
                }, 2000);
            });
        };

        // Auto-check on load
        setTimeout(() => {
            checkAuthState();
            checkLocalStorage();
        }, 1000);
    </script>
</body>
</html>