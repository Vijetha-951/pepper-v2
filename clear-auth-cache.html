<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clear Authentication Cache - Admin Fix</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; }
        .section { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 8px; }
        .success { background: #e8f5e9; border-left: 4px solid #4caf50; }
        .warning { background: #fff3e0; border-left: 4px solid #ff9800; }
        .error { background: #ffebee; border-left: 4px solid #f44336; }
        button { padding: 10px 15px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #2196f3; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn-success { background: #4caf50; color: white; }
        pre { background: #f0f0f0; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîß Admin Authentication Fix</h1>
    
    <div class="section warning">
        <h3>Current Issue:</h3>
        <p>You're having trouble accessing admin features (product management, user management, etc.) even though your account is correctly configured as admin.</p>
        <p><strong>This is likely due to cached authentication data that needs to be refreshed.</strong></p>
    </div>

    <div class="section">
        <h3>Step 1: Check Current Status</h3>
        <button class="btn-primary" onclick="checkCurrentStatus()">Check Authentication Status</button>
        <div id="status-output"></div>
    </div>

    <div class="section">
        <h3>Step 2: Clear All Authentication Data</h3>
        <button class="btn-danger" onclick="clearAllAuthData()">Clear All Auth Data</button>
        <p><small>This will clear localStorage, sessionStorage, cookies, and sign out from Firebase</small></p>
        <div id="clear-output"></div>
    </div>

    <div class="section">
        <h3>Step 3: Go Back and Login</h3>
        <button class="btn-success" onclick="goToLogin()">Go to Login Page</button>
        <p><small>After clearing auth data, you need to login again with vj.vijetha01@gmail.com</small></p>
    </div>

    <div class="section">
        <h3>Instructions:</h3>
        <ol>
            <li>Click "Clear All Auth Data" to remove cached authentication</li>
            <li>You'll be redirected to the login page</li>
            <li>Login with <strong>vj.vijetha01@gmail.com</strong> (not vijethajinu01@gmail.com)</li>
            <li>Your admin access should work properly now</li>
        </ol>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        function log(elementId, message, type = 'info') {
            const output = document.getElementById(elementId);
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'section';
            const timestamp = new Date().toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.className = className;
            logEntry.innerHTML = `<strong>${timestamp}:</strong> ${message}`;
            
            output.appendChild(logEntry);
            console.log(message);
        }

        function checkCurrentStatus() {
            const output = document.getElementById('status-output');
            output.innerHTML = ''; // Clear previous output
            
            log('status-output', 'üîç Checking authentication status...');
            
            // Check localStorage
            const storedUser = localStorage.getItem('user');
            const storedToken = localStorage.getItem('token');
            const currentUser = localStorage.getItem('currentUser');
            
            log('status-output', `localStorage 'user': ${storedUser ? 'EXISTS' : 'NONE'}`);
            log('status-output', `localStorage 'token': ${storedToken ? 'EXISTS' : 'NONE'}`);
            log('status-output', `localStorage 'currentUser': ${currentUser ? 'EXISTS' : 'NONE'}`);
            
            if (storedUser) {
                try {
                    const user = JSON.parse(storedUser);
                    log('status-output', `Stored email: ${user.email || 'NONE'}`, user.email === 'vj.vijetha01@gmail.com' ? 'success' : 'error');
                    log('status-output', `Stored role: ${user.role || 'NONE'}`, user.role === 'admin' ? 'success' : 'error');
                } catch (e) {
                    log('status-output', 'Error parsing stored user data', 'error');
                }
            }

            // Check sessionStorage
            const sessionKeys = Object.keys(sessionStorage);
            log('status-output', `sessionStorage keys: ${sessionKeys.length > 0 ? sessionKeys.join(', ') : 'NONE'}`);
            
            // Try to initialize Firebase (basic check)
            try {
                // Basic Firebase config for testing - replace with actual config if needed
                if (typeof firebase !== 'undefined') {
                    log('status-output', 'Firebase SDK loaded: YES', 'success');
                    
                    // Check if there's a current user (might not work without proper config)
                    if (firebase.auth && firebase.auth().currentUser) {
                        const fbUser = firebase.auth().currentUser;
                        log('status-output', `Firebase user: ${fbUser.email}`, 'success');
                    } else {
                        log('status-output', 'Firebase user: NONE');
                    }
                } else {
                    log('status-output', 'Firebase SDK loaded: NO', 'error');
                }
            } catch (e) {
                log('status-output', `Firebase check error: ${e.message}`, 'error');
            }
            
            log('status-output', '‚úÖ Status check complete');
        }

        function clearAllAuthData() {
            const output = document.getElementById('clear-output');
            output.innerHTML = ''; // Clear previous output
            
            log('clear-output', 'üßπ Starting comprehensive auth data cleanup...');
            
            // Clear localStorage
            try {
                const keysToRemove = ['user', 'token', 'currentUser', 'authToken', 'firebase:host:pepper-production-default', 'firebase:authUser:pepper-production'];
                let removedKeys = 0;
                
                // Remove specific keys
                keysToRemove.forEach(key => {
                    if (localStorage.getItem(key)) {
                        localStorage.removeItem(key);
                        removedKeys++;
                        log('clear-output', `Removed localStorage key: ${key}`);
                    }
                });
                
                // Remove any Firebase-related keys
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('firebase:') || key.startsWith('Firebase')) {
                        localStorage.removeItem(key);
                        removedKeys++;
                        log('clear-output', `Removed Firebase key: ${key}`);
                    }
                });
                
                log('clear-output', `‚úÖ Cleared ${removedKeys} localStorage keys`);
            } catch (e) {
                log('clear-output', `‚ùå localStorage clear error: ${e.message}`, 'error');
            }
            
            // Clear sessionStorage
            try {
                const sessionSize = sessionStorage.length;
                sessionStorage.clear();
                log('clear-output', `‚úÖ Cleared ${sessionSize} sessionStorage keys`);
            } catch (e) {
                log('clear-output', `‚ùå sessionStorage clear error: ${e.message}`, 'error');
            }
            
            // Clear cookies (domain-specific)
            try {
                document.cookie.split(";").forEach(function(c) { 
                    document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
                });
                log('clear-output', '‚úÖ Cleared cookies');
            } catch (e) {
                log('clear-output', `‚ùå Cookie clear error: ${e.message}`, 'error');
            }
            
            // Sign out from Firebase if possible
            try {
                if (typeof firebase !== 'undefined' && firebase.auth && firebase.auth().currentUser) {
                    firebase.auth().signOut().then(() => {
                        log('clear-output', '‚úÖ Signed out from Firebase');
                    }).catch((e) => {
                        log('clear-output', `‚ö†Ô∏è Firebase signout error: ${e.message}`, 'error');
                    });
                } else {
                    log('clear-output', '‚úÖ No Firebase user to sign out');
                }
            } catch (e) {
                log('clear-output', `‚ùå Firebase signout error: ${e.message}`, 'error');
            }
            
            log('clear-output', 'üéâ Authentication cleanup complete!', 'success');
            log('clear-output', 'üëâ Now click "Go to Login Page" to login fresh', 'success');
        }

        function goToLogin() {
            // Clear any remaining data one more time
            try {
                localStorage.clear();
                sessionStorage.clear();
            } catch (e) {
                console.log('Final cleanup error:', e);
            }
            
            // Redirect to login page
            if (window.location.hostname === 'localhost') {
                window.location.href = 'http://localhost:54113/login'; // Adjust port as needed
            } else {
                window.location.href = '/login';
            }
        }

        // Auto-run status check on page load
        window.addEventListener('load', function() {
            setTimeout(checkCurrentStatus, 500);
        });
    </script>
</body>
</html>