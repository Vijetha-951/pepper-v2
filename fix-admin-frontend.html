<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Fix Admin Access - Final Solution</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            padding: 20px; 
            max-width: 800px; 
            margin: 0 auto; 
            background: #f8fafc;
        }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .section { 
            background: #f8fafc; 
            padding: 20px; 
            margin: 20px 0; 
            border-radius: 8px; 
            border-left: 4px solid #3b82f6; 
        }
        .success { background: #ecfdf5; border-left-color: #10b981; }
        .warning { background: #fffbeb; border-left-color: #f59e0b; }
        .error { background: #fef2f2; border-left-color: #ef4444; }
        .critical { background: #1e293b; color: white; border-left-color: #ef4444; }
        button { 
            padding: 12px 20px; 
            margin: 8px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: 600;
            transition: all 0.2s;
        }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }
        pre { 
            background: #1e293b; 
            color: #e2e8f0; 
            padding: 15px; 
            border-radius: 6px; 
            overflow-x: auto; 
            font-size: 14px;
        }
        .status { padding: 10px; border-radius: 4px; margin: 10px 0; }
        .step { 
            background: white; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 6px; 
            border: 1px solid #e5e7eb; 
        }
        h1 { color: #1e293b; border-bottom: 2px solid #3b82f6; padding-bottom: 10px; }
        h2 { color: #374151; }
        .highlight { background: #fef3c7; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Fix Admin Access - Final Solution</h1>
        
        <div class="section success">
            <h2>‚úÖ Backend Status: FIXED</h2>
            <ul>
                <li>‚úÖ <span class="highlight">vj.vijetha01@gmail.com</span> is the exclusive admin</li>
                <li>‚úÖ <span class="highlight">vijethajinu01@gmail.com</span> is blocked from admin access</li>
                <li>‚úÖ All admin APIs are working correctly</li>
                <li>‚úÖ Authentication middleware is properly configured</li>
            </ul>
        </div>

        <div class="section error">
            <h2>‚ùå Frontend Issue: CACHED AUTHENTICATION</h2>
            <p>The problem is that your browser has <strong>stale authentication data</strong> that's preventing the correct admin access.</p>
        </div>

        <div class="section">
            <h2>üõ†Ô∏è Step-by-Step Fix</h2>
            
            <div class="step">
                <h3>Step 1: Clear All Authentication Data</h3>
                <button class="btn-danger" onclick="clearAllAuthData()">üßπ Clear All Auth Data</button>
                <p>This will remove all cached tokens, user data, and authentication state.</p>
                <div id="clear-output"></div>
            </div>
            
            <div class="step">
                <h3>Step 2: Check Current Status</h3>
                <button class="btn-primary" onclick="checkAuthStatus()">üîç Check Authentication Status</button>
                <div id="status-output"></div>
            </div>
            
            <div class="step">
                <h3>Step 3: Login with Correct Admin Account</h3>
                <div class="warning">
                    <p><strong>CRITICAL:</strong> You MUST login with:</p>
                    <pre>vj.vijetha01@gmail.com</pre>
                    <p><strong>NOT:</strong> vijethajinu01@gmail.com (this is blocked)</p>
                </div>
                <button class="btn-success" onclick="goToLogin()">üîë Go to Login Page</button>
            </div>
        </div>

        <div class="section critical">
            <h2>üö® IMPORTANT REMINDERS</h2>
            <ul>
                <li><strong>ONLY</strong> <span class="highlight">vj.vijetha01@gmail.com</span> has admin access</li>
                <li><strong>NEVER</strong> login with <span class="highlight">vijethajinu01@gmail.com</span> if you want admin access</li>
                <li>After clearing auth data, you MUST login fresh to get new tokens</li>
                <li>The admin features will work immediately after proper login</li>
            </ul>
        </div>

        <div class="section">
            <h2>üß™ Test Admin Functions</h2>
            <p>After logging in with the correct account, test these admin features:</p>
            <ul>
                <li>Product Management ‚Üí Should show all products and allow CRUD operations</li>
                <li>Stock Management ‚Üí Should show stock levels and allow restocking</li>
                <li>User Management ‚Üí Should show all users and allow role management</li>
                <li>Cart Management ‚Üí Should show cart data</li>
                <li>Order Management ‚Üí Should show orders and allow status updates</li>
            </ul>
        </div>

        <div class="section">
            <h2>üìù Debug Log</h2>
            <div id="debug-log" style="background: #1e293b; color: #e2e8f0; padding: 15px; border-radius: 6px; font-family: monospace; min-height: 100px; max-height: 300px; overflow-y: auto;"></div>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logElement = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : '#3b82f6';
            
            const logEntry = document.createElement('div');
            logEntry.style.color = colorClass;
            logEntry.style.marginBottom = '4px';
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const statusDiv = document.createElement('div');
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = message;
            element.appendChild(statusDiv);
        }

        function clearAllAuthData() {
            log('üßπ Starting comprehensive authentication cleanup...');
            
            const clearOutput = document.getElementById('clear-output');
            clearOutput.innerHTML = '';
            
            let clearedItems = 0;
            
            // Clear localStorage
            try {
                const localStorageKeys = [
                    'user', 'token', 'currentUser', 'authToken', 
                    'firebase:host:pepper-production-default',
                    'firebase:authUser:pepper-production',
                    'firebase:host:localhost:default',
                    'firebase:authUser:localhost'
                ];
                
                localStorageKeys.forEach(key => {
                    if (localStorage.getItem(key)) {
                        localStorage.removeItem(key);
                        clearedItems++;
                        log(`‚úÖ Removed localStorage: ${key}`);
                    }
                });
                
                // Remove any Firebase-related keys
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('firebase:') || key.startsWith('Firebase')) {
                        localStorage.removeItem(key);
                        clearedItems++;
                        log(`‚úÖ Removed Firebase key: ${key}`);
                    }
                });
                
                updateStatus('clear-output', `‚úÖ Cleared ${clearedItems} localStorage items`, 'success');
            } catch (e) {
                log(`‚ùå localStorage clear error: ${e.message}`, 'error');
                updateStatus('clear-output', `‚ùå localStorage error: ${e.message}`, 'error');
            }
            
            // Clear sessionStorage
            try {
                const sessionSize = sessionStorage.length;
                sessionStorage.clear();
                log(`‚úÖ Cleared ${sessionSize} sessionStorage items`);
                updateStatus('clear-output', `‚úÖ Cleared ${sessionSize} sessionStorage items`, 'success');
            } catch (e) {
                log(`‚ùå sessionStorage clear error: ${e.message}`, 'error');
                updateStatus('clear-output', `‚ùå sessionStorage error: ${e.message}`, 'error');
            }
            
            // Clear cookies
            try {
                let clearedCookies = 0;
                document.cookie.split(";").forEach(function(c) { 
                    if (c.trim()) {
                        document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
                        clearedCookies++;
                    }
                });
                log(`‚úÖ Cleared ${clearedCookies} cookies`);
                updateStatus('clear-output', `‚úÖ Cleared ${clearedCookies} cookies`, 'success');
            } catch (e) {
                log(`‚ùå Cookie clear error: ${e.message}`, 'error');
                updateStatus('clear-output', `‚ùå Cookie error: ${e.message}`, 'error');
            }
            
            log('üéâ Authentication cleanup complete!', 'success');
            updateStatus('clear-output', '<strong>üéâ All authentication data cleared!</strong><br>Now click "Go to Login Page" and login with vj.vijetha01@gmail.com', 'success');
        }

        function checkAuthStatus() {
            log('üîç Checking current authentication status...');
            
            const statusOutput = document.getElementById('status-output');
            statusOutput.innerHTML = '';
            
            // Check localStorage
            const storedUser = localStorage.getItem('user');
            const storedToken = localStorage.getItem('token');
            const currentUser = localStorage.getItem('currentUser');
            
            log(`localStorage 'user': ${storedUser ? 'EXISTS' : 'NONE'}`);
            log(`localStorage 'token': ${storedToken ? 'EXISTS' : 'NONE'}`);
            log(`localStorage 'currentUser': ${currentUser ? 'EXISTS' : 'NONE'}`);
            
            updateStatus('status-output', `localStorage - user: ${storedUser ? 'EXISTS' : 'NONE'}, token: ${storedToken ? 'EXISTS' : 'NONE'}`, storedUser ? 'warning' : 'success');
            
            if (storedUser) {
                try {
                    const user = JSON.parse(storedUser);
                    const email = user.email || 'NONE';
                    const role = user.role || 'NONE';
                    
                    log(`Stored email: ${email}`);
                    log(`Stored role: ${role}`);
                    
                    const isCorrectAdmin = email === 'vj.vijetha01@gmail.com' && role === 'admin';
                    const isWrongEmail = email === 'vijethajinu01@gmail.com';
                    
                    if (isCorrectAdmin) {
                        updateStatus('status-output', `‚úÖ CORRECT: ${email} with role ${role}`, 'success');
                        updateStatus('status-output', 'üéâ Authentication looks correct! If you\'re still having issues, try refreshing the page or clearing browser cache.', 'success');
                    } else if (isWrongEmail) {
                        updateStatus('status-output', `‚ùå WRONG ACCOUNT: ${email} - This account is blocked from admin access!`, 'error');
                        updateStatus('status-output', 'üö® You need to clear auth data and login with vj.vijetha01@gmail.com', 'error');
                    } else {
                        updateStatus('status-output', `‚ö†Ô∏è UNEXPECTED: ${email} with role ${role}`, 'warning');
                    }
                } catch (e) {
                    log(`Error parsing stored user: ${e.message}`, 'error');
                    updateStatus('status-output', '‚ùå Stored user data is corrupted - please clear auth data', 'error');
                }
            } else {
                updateStatus('status-output', '‚úÖ No stored user data (clean state)', 'success');
                updateStatus('status-output', 'üëâ Ready for fresh login with vj.vijetha01@gmail.com', 'success');
            }
            
            // Check sessionStorage
            const sessionKeys = Object.keys(sessionStorage);
            log(`sessionStorage keys: ${sessionKeys.length > 0 ? sessionKeys.join(', ') : 'NONE'}`);
            updateStatus('status-output', `sessionStorage: ${sessionKeys.length} keys`, sessionKeys.length > 0 ? 'warning' : 'success');
            
            log('‚úÖ Status check complete');
        }

        function goToLogin() {
            log('üîÑ Redirecting to login page...', 'success');
            
            // One final cleanup
            try {
                localStorage.clear();
                sessionStorage.clear();
                log('‚úÖ Final cleanup completed');
            } catch (e) {
                log(`‚ö†Ô∏è Final cleanup warning: ${e.message}`, 'error');
            }
            
            // Redirect to login
            setTimeout(() => {
                if (window.location.hostname === 'localhost') {
                    window.location.href = 'http://localhost:54113/login';
                } else {
                    window.location.href = '/login';
                }
            }, 500);
        }

        // Auto-check status on page load
        window.addEventListener('load', function() {
            setTimeout(() => {
                log('üîÑ Page loaded - checking authentication status...', 'info');
                checkAuthStatus();
            }, 500);
        });
    </script>
</body>
</html>